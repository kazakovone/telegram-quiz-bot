import os
from collections import Counter

from telegram import (
    Update,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)
from telegram.constants import ParseMode
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    ContextTypes,
    CallbackQueryHandler,
)

# ---------- Конфигурация ----------

TEMPLATES_URL = "https://vigbo.com/templates"
CABINET_URL = "https://clients.vigbo.com/area/main.php"
JULIA_URL = "https://t.me/julia_vigbo"

# ---------- Вопросы (все варианты <= 64 символов) ----------

QUESTIONS = [
    {
        "title": "Вопрос 1 из 15",
        "question": "Что для тебя самое важное в фотографии?",
        "options": [
            "1. Передать идею и смысл, кадр, который что-то говорит.",
            "2. Поймать настоящее чувство и создать доверие.",
            "3. Сделать качественную, востребованную, продающую съёмку.",
            "4. Замечать тишину, свет и движение, не вмешиваясь.",
            "5. Рассказать историю, чтобы человек прожил её, глядя.",
        ],
    },
    {
        "title": "Вопрос 2 из 15",
        "question": "Когда ты снимаешь, ты чаще думаешь о…",
        "options": [
            "1. Цвете, композиции, свете, чтобы всё совпадало с идеей.",
            "2. Настроении человека и атмосфере вокруг.",
            "3. Качестве картинки, технике и структуре работы.",
            "4. Как герои кадра и пространство взаимодействуют.",
            "5. О том, какую историю я создаю серией и кадрами.",
        ],
    },
    {
        "title": "Вопрос 3 из 15",
        "question": "Что тебе ближе в работе с клиентом?",
        "options": [
            "1. Дать вдохновение и творческую идею.",
            "2. Поддержать и помочь человеку раскрыться.",
            "3. Чётко объяснить процесс, чтобы всё прошло гладко.",
            "4. Наблюдать, не мешая, ловить естественные моменты.",
            "5. Помочь человеку увидеть себя как героя истории.",
        ],
    },
    {
        "title": "Вопрос 4 из 15",
        "question": "Как ты отбираешь фото в портфолио?",
        "options": [
            "1. Фото с лучшей передачей твоей идеи.",
            "2. Фото, где видно чувство и эмоции.",
            "3. Фото, где всё выполнено идеально и качественно.",
            "4. Фото с воздухом, покоем и честностью момента.",
            "5. Фото, которые вместе складываются в рассказ.",
        ],
    },
    {
        "title": "Вопрос 5 из 15",
        "question": "Что для тебя «идеальный сайт»?",
        "options": [
            "1. Как арт-пространство.",
            "2. Как уютный разговор с друзьями.",
            "3. Как инструмент – понятный, структурный, эффективный.",
            "4. Как галерея работ с минималистичным пространством.",
            "5. Как фильм или книга, чтобы человек проживал историю.",
        ],
    },
    {
        "title": "Вопрос 6 из 15",
        "question": "Что ты чувствуешь, когда выкладываешь снимки?",
        "options": [
            "1. Лёгкое волнение – это часть души.",
            "2. Радость от возможности делиться теплом.",
            "3. Гордость за профессиональный результат.",
            "4. Тихое удовлетворение, без нужды в аплодисментах.",
            "5. Интерес – что почувствуют люди, увидев историю.",
        ],
    },
    {
        "title": "Вопрос 7 из 15",
        "question": "Как ты относишься к трендам в фотографии?",
        "options": [
            "1. Вдохновляюсь трендами, но делаю по-своему.",
            "2. Беру идеи, если они близки по духу.",
            "3. Следую трендам, которые приносят клиентов.",
            "4. Наблюдаю со стороны, не спешу повторять.",
            "5. Люблю timeless-стиль, важно, чтобы фото жили дольше.",
        ],
    },
    {
        "title": "Вопрос 8 из 15",
        "question": "Что для тебя сложнее всего?",
        "options": [
            "1. Закончить проект, хочется идеального результата.",
            "2. Говорить о себе и продвигать свои услуги.",
            "3. Находить вдохновение, когда много рутины.",
            "4. Делать съёмки «на показ» – не люблю суету.",
            "5. Структурировать материал, чтобы всё сложилось.",
        ],
    },
    {
        "title": "Вопрос 9 из 15",
        "question": "Как можно описать одним словом твою съёмку?",
        "options": [
            "1. Атмосферная.",
            "2. Живая.",
            "3. Уверенная.",
            "4. Спокойная.",
            "5. Цельная.",
        ],
    },
    {
        "title": "Вопрос 10 из 15",
        "question": "Как ты принимаешь решения по проектам?",
        "options": [
            "1. По вдохновению.",
            "2. Через ощущение «моё / не моё».",
            "3. По логике и заранее продуманному плану.",
            "4. Через внутреннюю тишину, без спешки.",
            "5. Через историю, которую хочется рассказать.",
        ],
    },
    {
        "title": "Вопрос 11 из 15",
        "question": "Что ты хочешь, чтобы люди чувствовали, глядя на твои фото?",
        "options": [
            "1. Вдохновение и желание задуматься.",
            "2. Тепло, принятие и поддержку.",
            "3. Уверенность, надёжность и стабильность.",
            "4. Спокойствие и гармонию.",
            "5. Увлечённость и погружение в историю.",
        ],
    },
    {
        "title": "Вопрос 12 из 15",
        "question": "Какая фраза ближе тебе?",
        "options": [
            "1. «Фотография – это язык света.»",
            "2. «Главное – быть рядом и видеть человека.»",
            "3. «Хорошая работа говорит сама за себя.»",
            "4. «Я просто наблюдаю, мир делает остальное.»",
            "5. «Каждый кадр – фраза в большой истории.»",
        ],
    },
    {
        "title": "Вопрос 13 из 15",
        "question": "Когда ты думаешь о будущем, тебе ближе…",
        "options": [
            "1. Творческие проекты и развитие своего стиля.",
            "2. Своя аудитория и тёплое сообщество клиентов.",
            "3. Устойчивость, стабильность и поток заказов.",
            "4. Свобода и больше времени на себя и смысл.",
            "5. Авторская серия, выставка, визуальная история.",
        ],
    },
    {
        "title": "Вопрос 14 из 15",
        "question": "Какой комплимент тебе особенно приятен?",
        "options": [
            "1. «Это – искусство.»",
            "2. «С тобой так легко.»",
            "3. «Профессионально и безупречно.»",
            "4. «Твои фото, как медитация.»",
            "5. «Эта серия – как прекрасный фильм.»",
        ],
    },
    {
        "title": "Вопрос 15 из 15",
        "question": "Когда ты создаёшь сайт, что для тебя важно?",
        "options": [
            "1. Чтобы сайт был отражением моего внутреннего мира.",
            "2. Живое ощущение присутствия и тепла.",
            "3. Понятная структура, логика и удобные кнопки.",
            "4. Простота, воздух и крупные фотографии.",
            "5. Цельное повествование, как одна большая история.",
        ],
    },
]

# ---------- Описания типов (как раньше) ----------

TYPE_TEXTS = {
    1: (
        "<b>Ты – Фотограф-творец.</b>\n\n"
        "Ты снимаешь, чтобы выразить внутренний мир, в каждом твоём кадре личная история и смысл. "
        "Ты не гонишься за трендами – ты создаёшь свои. Люди чувствуют в твоих фото глубину и атмосферу.\n\n"
        "<b>Твоя сила:</b> глубина, идея, художественность.\n\n"
        "<b>Какой сайт тебе подходит:</b>\n"
        "Сайт как арт-пространство: атмосферный, самобытный, с акцентом на визуальные решения и смысл.\n\n"
        "<b>Структура сайта:</b>\n"
        "• Главная – крупное фото + серия кадров и лаконичный текст с философией.\n"
        "• Портфолио – не по типам съёмок, а по темам и эмоциям.\n"
        "• Обо мне – как мини-интервью о взгляде на фотографию.\n"
        "• Контакты – минималистично, но с душой: «Напиши, если чувствуешь, что наши миры пересекаются».\n\n"
        "<b>Визуал:</b> много воздуха, мягкая типографика, нейтральные цвета.\n"
        "<b>Тексты:</b> короткие, метафоричные, авторские.\n\n"
        "<b>Фишки:</b> избранные серии, блог как арт-дневник, музыка, под которую ты снимаешь.\n\n"
        "<b>Шаблоны-вдохновения:</b> Sia, Pogy, Jersey."
    ),
    2: (
        "<b>Ты – Фотограф-эмпат.</b>\n\n"
        "Ты чувствуешь людей, создаёшь атмосферу доверия и тепла. Съёмка с тобой – как время с близким человеком.\n\n"
        "<b>Твоя сила:</b> эмоциональная близость, искренность, забота.\n\n"
        "<b>Какой сайт тебе подходит:</b>\n"
        "Тёплый, человечный сайт, который ощущается как живой разговор, а не реклама услуг.\n\n"
        "<b>Структура сайта:</b>\n"
        "• Главная – серия клиентских кадров, улыбки, объятия, динамика.\n"
        "• Обо мне – о человеке, который снимает с любовью.\n"
        "• Портфолио – истории клиентов по сериям.\n"
        "• Отзывы – живые цитаты.\n"
        "• Контакты – форма и мессенджеры, чтобы можно было сразу написать.\n\n"
        "<b>Визуал:</b> тёплые оттенки, естественный свет, много живых моментов.\n"
        "<b>Тексты:</b> простые, разговорные, от первого лица.\n\n"
        "<b>Фишки:</b> блок отзывов с портретами, гиф или видео с процесса, форма «Записаться на съёмку».\n\n"
        "<b>Шаблоны-вдохновения:</b> Agnia, Klara, Elena, Melissa."
    ),
    3: (
        "<b>Ты – Фотограф-практик.</b>\n\n"
        "Ты системный и надёжный. Любишь чёткий процесс и видишь ценность в результате. "
        "Твоя съёмка продуманная, структурная, с пониманием задачи.\n\n"
        "<b>Твоя сила:</b> системность, профессионализм, уверенность.\n\n"
        "<b>Какой сайт тебе подходит:</b>\n"
        "Ясный и продуманный сайт с понятной структурой и быстрым путём к записи.\n\n"
        "<b>Структура сайта:</b>\n"
        "• Главная – сразу понятно, чем ты занимаешься.\n"
        "• Портфолио – разделение по видам съёмок.\n"
        "• Цены / Услуги – чётко структурировано, с описанием пакетов.\n"
        "• Отзывы и клиенты – социальное доказательство.\n"
        "• Контакты / заявка – быстрая форма.\n\n"
        "<b>Визуал:</b> строго, но не скучно; контрастные фото, геометрия.\n"
        "<b>Тексты:</b> ясные и конкретные, без лишней художественности.\n\n"
        "<b>Фишки:</b> страница «Кейсы», форма «Забронировать дату», SEO-настройки.\n\n"
        "<b>Шаблоны-вдохновения:</b> Raisa, Nikita, Oscar, Beverley."
    ),
    4: (
        "<b>Ты – Фотограф-наблюдатель.</b>\n\n"
        "Ты тонкий и внимательный. Замечаешь красоту в простом и естественном, предпочитаешь смотреть, "
        "а не быть в центре внимания.\n\n"
        "<b>Твоя сила:</b> наблюдательность, глубина, стиль.\n\n"
        "<b>Какой сайт тебе подходит:</b>\n"
        "Минималистичный сайт с акцентом на воздух, пространство и покой.\n\n"
        "<b>Структура сайта:</b>\n"
        "• Главная – одно фото на весь экран и небольшая галерея.\n"
        "• Портфолио – визуальные серии с минимумом текста.\n"
        "• Обо мне – 3–4 искренних предложения.\n"
        "• Контакты – мягко: «Если тебе откликается – напиши».\n\n"
        "<b>Визуал:</b> белое пространство, натуральные цвета, пастельные акценты.\n"
        "<b>Тексты:</b> минимализм и смысл.\n\n"
        "<b>Фишки:</b> аккуратные галереи, ссылка на Telegram-канал с наблюдениями.\n\n"
        "<b>Шаблоны-вдохновения:</b> Agnia, Polina, Pogy, Bruno, Raisa, Jersey."
    ),
    5: (
        "<b>Ты – Фотограф-история.</b>\n\n"
        "Ты видишь жизнь как рассказ. Каждая серия – глава, каждая съёмка – сюжет. "
        "Ты больше про движение и связь, чем про позы.\n\n"
        "<b>Твоя сила:</b> целостность, ритм, интуиция.\n\n"
        "<b>Какой сайт тебе подходит:</b>\n"
        "Сайт-поток, который хочется листать, как фильм.\n\n"
        "<b>Структура сайта:</b>\n"
        "• Главная – динамичная серия кадров с движением.\n"
        "• Мои истории – съёмки как главы: обложка, текст, серия фото.\n"
        "• Обо мне – через историю, как ты пришёл(а) в фотографию.\n"
        "• Услуги – «Что я могу рассказать о вас».\n\n"
        "<b>Визуал:</b> вертикальные фото, чередование форматов, тёплая палитра.\n"
        "<b>Тексты:</b> как сценарий – с началом, атмосферой и кульминацией.\n\n"
        "<b>Фишки:</b> страница «Серии», блог с закулисьем, форма "
        "«Расскажите подробнее о вашей истории».\n\n"
        "<b>Шаблоны-вдохновения:</b> Raisa, Oscar, Agnia, Paris, Cardo, Andre, Moon."
    ),
}


# ---------- Вспомогательные функции ----------

def build_question_keyboard(options: list[str]) -> InlineKeyboardMarkup:
    buttons = [
        [InlineKeyboardButton(text=opt, callback_data=f"ans_{i + 1}")]
        for i, opt in enumerate(options)
    ]
    return InlineKeyboardMarkup(buttons)


def build_final_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton(
                    text="Посмотреть шаблоны сайтов от Vigbo", url=TEMPLATES_URL
                )
            ],
            [
                InlineKeyboardButton(
                    text="Перейти в личный кабинет Vigbo", url=CABINET_URL
                )
            ],
            [
                InlineKeyboardButton(
                    text="Пройти тест ещё раз", callback_data="restart_quiz"
                )
            ],
        ]
    )


def build_julia_keyboard() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(
        [
            [
                InlineKeyboardButton(
                    text="Написать Юле в Telegram", url=JULIA_URL
                )
            ]
        ]
    )


async def send_question(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    q_index = context.user_data.get("q_index", 0)
    if q_index >= len(QUESTIONS):
        return

    q = QUESTIONS[q_index]
    text = f"<b>{q['title']}</b>\n\n{q['question']}"
    keyboard = build_question_keyboard(q["options"])

    if update.callback_query:
        await update.callback_query.edit_message_text(
            text=text,
            reply_markup=keyboard,
            parse_mode=ParseMode.HTML,
        )
    else:
        await update.effective_chat.send_message(
            text=text,
            reply_markup=keyboard,
            parse_mode=ParseMode.HTML,
        )


# ---------- Хендлеры ----------

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    text = (
        "Привет! Это тест <b>«Какой ты фотограф?»</b>\n\n"
        "После 15 вопросов ты узнаешь свой тип и получишь персональные рекомендации "
        "по сайту и шаблонам Vigbo.\n\n"
        "Отвечай интуитивно — выбирай вариант, который ближе по ощущению."
    )
    keyboard = InlineKeyboardMarkup(
        [[InlineKeyboardButton("Начать тест", callback_data="start_quiz")]]
    )
    await update.message.reply_text(
        text=text,
        reply_markup=keyboard,
        parse_mode=ParseMode.HTML,
    )


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    data = query.data
    await query.answer()

    if data in ("start_quiz", "restart_quiz"):
        context.user_data["answers"] = []
        context.user_data["q_index"] = 0
        await send_question(update, context)
        return

    if data.startswith("ans_"):
        try:
            choice = int(data.split("_")[1])
        except ValueError:
            return

        answers = context.user_data.get("answers", [])
        answers.append(choice)
        context.user_data["answers"] = answers

        q_index = context.user_data.get("q_index", 0) + 1
        context.user_data["q_index"] = q_index

        if q_index < len(QUESTIONS):
            await send_question(update, context)
        else:
            await show_results(update, context)


async def show_results(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    answers = context.user_data.get("answers", [])
    if not answers:
        await update.callback_query.edit_message_text(
            "Похоже, тест не был пройден. Нажми «Начать тест», чтобы попробовать ещё раз."
        )
        return

    from collections import Counter
    counts = Counter(answers)
    for t in range(1, 6):
        counts.setdefault(t, 0)

    max_count = max(counts.values())
    dominant = [t for t, c in counts.items() if c == max_count]

    if len(dominant) == 1:
        intro = "Готово! Вот твой ведущий тип фотографа:\n"
    else:
        type_names = {
            1: "Творец",
            2: "Эмпат",
            3: "Практик",
            4: "Наблюдатель",
            5: "История",
        }
        labels = ", ".join(type_names[t] for t in dominant)
        intro = (
            "Готово! Похоже, в тебе сочетаются несколько типов — "
            f"<b>{labels}</b>. Это и есть твоя уникальность.\n\n"
            "Ниже — описания всех твоих ведущих граней:\n"
        )

    await update.callback_query.edit_message_text(
        intro, parse_mode=ParseMode.HTML
    )

    chat = update.effective_chat

    for t in dominant:
        text = TYPE_TEXTS.get(t)
        if text:
            await chat.send_message(
                text=text,
                parse_mode=ParseMode.HTML,
            )

    final_text = (
        "Каждый фотограф — это сочетание нескольких граней.\n"
        "Когда ты понимаешь, кто ты как фотограф, проще создать свою цельную вселенную, "
        "которая говорит со зрителем без слов."
    )

    await chat.send_message(
        text=final_text,
        reply_markup=build_final_keyboard(),
        parse_mode=ParseMode.HTML,
    )

    julia_text = (
        "Если остались вопросы по созданию сайта, которые хочется обсудить вслух "
        "или просто попросить совет – напиши менеджеру Vigbo Юле. "
        "Она рядом и всегда постарается помочь."
    )

    await chat.send_message(
        text=julia_text,
        reply_markup=build_julia_keyboard(),
        parse_mode=ParseMode.HTML,
    )


# ---------- Запуск приложения ----------

def main() -> None:
    token = os.getenv("BOT_TOKEN")
    if not token:
        raise RuntimeError("Не найден токен. Установи переменную окружения BOT_TOKEN.")

    application = ApplicationBuilder().token(token).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(CallbackQueryHandler(button_handler))

    application.run_polling()


if __name__ == "__main__":
    main()
